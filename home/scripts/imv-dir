#!/usr/bin/env bash

# Wrapper for imv that opens all images in the same directory
# and starts at the selected file. Used by Thunar/xdg-open.

FILE="$1"
[ -z "$FILE" ] && exit 1

DIR="$(dirname "$FILE")"
BASENAME="$(basename "$FILE")"

# Collect all common image files in the directory, sorted
IMAGES=()
while IFS= read -r -d '' img; do
    IMAGES+=("$img")
done < <(find "$DIR" -maxdepth 1 -type f \( \
    -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o \
    -iname '*.gif' -o -iname '*.bmp' -o -iname '*.webp' -o \
    -iname '*.tiff' -o -iname '*.svg' \) -print0 | sort -z)

if [ ${#IMAGES[@]} -eq 0 ]; then
    exec imv "$FILE"
fi

# Find the index of the selected file to start there
INDEX=0
for i in "${!IMAGES[@]}"; do
    if [ "$(basename "${IMAGES[$i]}")" = "$BASENAME" ]; then
        INDEX=$i
        break
    fi
done

exec imv -n "$((INDEX + 1))" "${IMAGES[@]}"
