#!/usr/bin/env bash

# Wrapper for imv that opens all images in the same directory
# and starts at the selected file. Used by Thunar/xdg-open.

FILE="$1"
[ -z "$FILE" ] && exit 1

# Resolve symlinks so we work with real files (needed for NixOS/Home Manager)
FILE="$(readlink -f "$FILE")"
DIR="$(dirname "$FILE")"
BASENAME="$(basename "$FILE")"

# Collect all common image files using glob (works with symlinks unlike find -type f)
shopt -s nullglob nocaseglob
IMAGES=()
for img in "$DIR"/*.{jpg,jpeg,png,gif,bmp,webp,tiff,svg}; do
    [ -e "$img" ] && IMAGES+=("$img")
done
shopt -u nullglob nocaseglob

# Sort
IFS=$'\n' IMAGES=($(printf '%s\n' "${IMAGES[@]}" | sort)); unset IFS

if [ ${#IMAGES[@]} -eq 0 ]; then
    exec imv "$FILE"
fi

# Find the index of the selected file to start there
INDEX=0
for i in "${!IMAGES[@]}"; do
    if [ "$(basename "${IMAGES[$i]}")" = "$BASENAME" ]; then
        INDEX=$i
        break
    fi
done

exec imv -n "$((INDEX + 1))" "${IMAGES[@]}"
